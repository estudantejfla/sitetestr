<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Criar Time</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <video autoplay muted loop id="bg-video" class="background-video">
    <source src="imagens/background.mp4" type="video/mp4">
  </video>
  <div class="container">
    <div class="navbar">
    <a href="blog.html">Blog</a>
    <a href="postar.html">Nova Postagem</a>
    <a href="times.html">Meus Times</a>
    <a href="criar_time.html">Criar Time</a>
    <a href="publicos.html">Times Públicos</a>
    <a href="faq.html">FAQ</a>
    <a href="depoimentos.html">Depoimentos</a>
    <a href="sobre.html">Sobre</a>
  </div>

    <h1>Criar/Editar Time</h1>
    <p>Usuário: <span id="usuario"></span></p>
    <input id="nomeTime" placeholder="Nome do Time"><br>

    <h3>Seu Time</h3>
    <div id="slots" class="grid"></div>

    <div id="pokemonModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <input type="text" id="pokemonSearch" oninput="buscarPokemon()" placeholder="Buscar Pokémon...">
        <div id="pokemonList" class="grid"></div>
      </div>
    </div>

    <button onclick="salvarTime()">Salvar Time</button><br><br>
    <button onclick="limparTime()" style="background-color: #f44336;">Limpar Time</button><br><br>
    <a href="times.html">Voltar</a>

    <script>
      let user = localStorage.getItem("logado");
      let contas = JSON.parse(localStorage.getItem("contas")) || {};
      if (!user || !contas[user]) {
        
        window.location.href = "index.html";
      }
      document.getElementById("usuario").textContent = user;

      let slots = [];
      let editingIndex = -1;
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('edit')) {
        editingIndex = parseInt(urlParams.get('edit'));
        let time = contas[user].times[editingIndex];
        if (time) {
          document.getElementById("nomeTime").value = time.nome;
          slots = [...time.pokemons];
        }
      }

      // Objeto para mapear nomes de Pokémon para seus IDs
      let pokemonIdMap = {};

      function mostrarSlots() {
        let container = document.getElementById("slots");
        container.innerHTML = "";
        for (let i = 0; i < 6; i++) {
          let div = document.createElement("div");
          div.className = "card";
          if (slots[i]) {
            // Usa o ID do mapeamento em vez de tentar calcular
            let pokemonId = pokemonIdMap[slots[i].toLowerCase()];
            div.innerHTML = `
              <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${pokemonId}.png">
              <p>${slots[i]}</p>
              <button onclick="removerPokemon(${i})">Remover</button>
            `;
          } else {
            div.innerHTML = `<button onclick="abrirModal(${i})">Adicionar Pokémon</button>`;
          }
          container.appendChild(div);
        }
      }

      let pokemonList = [];
      let modal = document.getElementById("pokemonModal");
      let currentSlot = 0;

      function abrirModal(i) {
        currentSlot = i;
        modal.style.display = "block";
      }

      function fecharModal() {
        modal.style.display = "none";
      }

      async function carregarPokemons(){
        let container = document.getElementById("pokemonList");
        container.innerHTML = "";
        let invalid = ["mega","gmax","gigantamax","eternamax","totem"];
        
        for (let i = 1; i <= 1025; i++) {
          try {
            let res = await fetch(`https://pokeapi.co/api/v2/pokemon/${i}`);
            if(!res.ok) continue;
            let poke = await res.json();
            let name = poke.name;
            let lower = name.toLowerCase();
            let skip = invalid.some(s=> lower.includes(s));
            if(skip) continue;
            
            // Armazena o mapeamento nome->ID
            pokemonIdMap[name.toLowerCase()] = i;
            
            let div = document.createElement("div");
            div.className = "card";
            div.innerHTML = `<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${i}.png"><p>${name}</p><button onclick="selecionarPokemon('${name}')">Adicionar</button>`;
            container.appendChild(div);
          } catch(e){
            console.error("Erro ao carregar Pokémon:", e);
          }
        }
      }

      function selecionarPokemon(nome) {
        slots[currentSlot] = nome;
        mostrarSlots();
        fecharModal();
      }

      function removerPokemon(i) {
        slots[i] = null;
        mostrarSlots();
      }

      function buscarPokemon() {
        let termo = document.getElementById("pokemonSearch").value.toLowerCase();
        let cards = document.querySelectorAll("#pokemonList .card");
        cards.forEach(card => {
          let nome = card.querySelector("p").textContent.toLowerCase();
          card.style.display = nome.includes(termo) ? "block" : "none";
        });
      }

      function salvarTime() {
        let nome = document.getElementById("nomeTime").value;
        let pokemons = slots.filter(p => p);
        if (!nome || pokemons.length === 0) {
          
          return;
        }
        let time = { nome, pokemons };
        if (editingIndex >= 0) contas[user].times[editingIndex] = time;
        else contas[user].times.push(time);
        localStorage.setItem("contas", JSON.stringify(contas));
        
        window.location.href = "times.html";
      }

      function limparTime() {
        slots = [];
        document.getElementById("nomeTime").value = "";
        mostrarSlots();
      }

      document.querySelector(".close").onclick = fecharModal;
      window.onclick = e => { if (e.target == modal) fecharModal(); }
      document.getElementById("pokemonSearch").addEventListener("input", buscarPokemon);

      mostrarSlots();
      carregarPokemons();
    </script>
  </div>
</body>
</html>